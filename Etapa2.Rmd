---
title: "Etapa 2"
author: "Alys Jiménez"
date: "`r Sys.Date()`"
output: html_document
---
```{r}
library(dplyr)
library(ggplot2)
library(printr)

setwd("/Users/alysjime/Downloads")
getwd()
datos_2024 <- read.csv("Datos_molec_2024-1.csv")
datos_2023 <- read.csv("Datos_molec_2023-1.csv")
datos_2022 <- read.csv("Datos_molec_2022-1.csv")
datos_2021 <- read.csv("Datos_molec_2021-1.csv")
datos_2020 <- read.csv("Datos_molec_2020-1.csv")
datos_2019 <- read.csv("Datos_molec_2019-1.csv")
```

```{r}
#Hacer nuevas bases con solo las variables por analizar
d_2024 <- datos_2024 %>% 
  select(sexo,entidad,edad,nivel,p1,p2,p4,p10,p16,p22,p3_5,p26,p31,p33_3,p33_4,p33_1)

d_2023 <- datos_2023 %>% 
  select(sexo,entidad,edad,nivel,p1,p2,p4,p10,p16,p22,p3_5,p26,p31,p33_3,p33_4,p33_1)

d_2022 <- datos_2022 %>% 
  select(sexo,entidad,edad,nivel,p1,p2,p4,p10,p16,p22,p3_5,p26,p31,p33_3,p33_4,p33_1)

d_2021 <- datos_2021 %>% 
  select(sexo,entidad,edad,nivel,p1,p2,p4,p10,p16,p22,p3_5,p26,p31,p33_3,p33_4,p33_1)

d_2020 <- datos_2020 %>% 
  select(sexo,entidad,edad,nivel,p1,p2,p4,p10,p16,p22,p3_5,p26,p31,p33_3,p33_4,p33_1)

d_2019 <- datos_2019 %>% 
  select(sexo,entidad,edad,nivel,p1,p2,p4,p10,p16,p22,p3_5,p26,p31,p33_3,p33_4,p33_1)

```


```{r}
#Añadir columna de año para poder combinar y comparar los datos
d_2024 <- d_2024 %>% 
  mutate(anio= 2024)

d_2023 <- d_2023 %>% 
  mutate(anio= 2023)

d_2022 <- d_2022 %>% 
  mutate(anio= 2022)

d_2021 <- d_2021 %>% 
  mutate(anio= 2021)

d_2020 <- d_2020 %>% 
  mutate(anio= 2020)

d_2019 <- d_2019 %>% 
  mutate(anio= 2019)

#Combinar todos los años
datos <- bind_rows(d_2024,d_2023,d_2022,d_2021,d_2020,d_2019)
glimpse(datos)

# Calculate the percentage of missing data for specific columns
missing_summary <- datos %>%
  summarise(
    porcentaje_NA_edad = (sum(is.na(edad)) / n()) * 100,
    porcentaje_NA_anio = (sum(is.na(anio)) / n()) * 100
  )

# Print the results, rounded to 2 decimal places
print(round(missing_summary, 2))

```
```{r}
#Agrupar por generacion
datos <- datos %>%
  mutate(
    anio_de_nacimiento = anio - edad,
    generacion = case_when(
      anio_de_nacimiento >= 1997 ~ "Gen Z",
      anio_de_nacimiento >= 1981 & anio_de_nacimiento <= 1996 ~ "Millennial",
      anio_de_nacimiento >= 1965 & anio_de_nacimiento <= 1980 ~ "Gen X",
      anio_de_nacimiento <= 1964 ~ "Boomer"
    )
  ) %>%
  select(-anio_de_nacimiento)

datos %>%
  count(generacion, sort = TRUE)
```


```{r}
#A groupar por generación
datos <- datos %>%
  mutate(
    anio_de_nacimiento = anio-edad,
    generacion = case_when(
      anio_de_nacimiento >= 1997 ~ "Gen Z",
      anio_de_nacimiento >= 1981 & anio_de_nacimiento <= 1996 ~ "Millennial",
      anio_de_nacimiento >= 1965 & anio_de_nacimiento <= 1980 ~ "Gen X",
      anio_de_nacimiento <= 1964 ~ "Boomer"
    )
  ) %>% 
  select(-anio_de_nacimiento)

datos %>%
  count(generacion, sort = TRUE)
```


```{r}
#Remplazar 1 y 2 con mujer y hombre
datos <- datos %>%
    mutate(sexo = case_when(
      sexo == 1 ~ "Hombre",
      sexo == 2 ~ "Mujer"
  )
    )
#Analisis por Sexo
datos %>% 
 count(p4, sort=TRUE)

rows_with_b <- datos %>%
  filter(p2 == "b")

#Promedio de libros leidos por sexo
books_by_sex_year <- datos %>%
  group_by(anio, sexo) %>%
  summarize(libros_promedio = mean(p4), .groups = 'drop')

#Grafica de barra
ggplot(books_by_sex_year, aes(x = anio, y = libros_promedio, fill = sexo)) +
  geom_col(position = "dodge") + 
  labs(
    title = "Promedio Anual de Libros Leídos por Sexo",
    x = "Año",
    y = "Número de Libros Promedio",
    fill = "Sexo"
  )
```

```{r}
books_by_gen_year <- datos %>%
  group_by(anio, generacion) %>%
  summarize(libros_promedio = mean(p4), .groups = 'drop') %>%
  filter(!is.na(generacion))

ggplot(books_by_gen_year, aes(x = anio, y = libros_promedio, color = generacion)) +
  geom_line(linewidth = 1.5) +
  geom_point(size = 3) +
  labs(
    title = "Promedio Anual de Libros Leídos por Generación",
    x = "Año",
    y = "Número de Libros Promedio",
    color = "Generación"
  )
```

```{r}
datos <- datos %>%
  mutate(nivel_educativo_detallado = case_when(
    nivel == 0 ~ "Ninguno",
    nivel == 01 ~ "Preescolar",
    nivel == 02 ~ "Primaria",
    nivel == 03 ~ "Secundaria",
    nivel == 04 ~ "Preparatoria",
    nivel == 05 ~ "Normal básica",
    nivel == 06 ~ "Carrera técnica",
    nivel == 07 ~ "Profesional",
    nivel == 08 ~ "Maestría",
    nivel == 09 ~ "Doctorado",
    nivel == 99 ~ "No sabe"
  ))

books_by_education_detailed <- datos %>%
  group_by(anio, nivel_educativo_detallado) %>%
  summarize(libros_promedio = mean(p4), .groups = 'drop') %>%
  filter(nivel_educativo_detallado != "No sabe" & !is.na(nivel_educativo_detallado))

ggplot(books_by_education_detailed, aes(x = anio, y = libros_promedio, color = nivel_educativo_detallado)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2.5) +
  labs(
    title = "Promedio Anual de Libros Leídos por Nivel Educativo",
    x = "Año",
    y = "Número de Libros Promedio",
    color = "Nivel Educativo"
  )

```

```{r}
datos <- datos %>%
  mutate(
    asistencia_nino = case_when(
      p33_1 == "1" ~ "Sí lo llevaban",
      p33_1 == "2" ~ "No lo llevaban",
    ),
    asistio_biblioteca_reciente = case_when(
      p33_3 == "1" ~ "Sí",
      p33_3 == "2" ~ "No",
    ),
    asistio_libreria_reciente = case_when(
      p33_4 == "1" ~ "Sí",
      p33_4 == "2" ~ "No",
    )
  )

library_habits <- datos %>% #biblioteca
  filter(!is.na(asistencia_nino) & !is.na(asistio_biblioteca_reciente)) %>%
  group_by(asistencia_nino) %>%
  summarize(
    porcentaje_asistencia = mean(asistio_biblioteca_reciente == "Sí") * 100
  ) %>%
  mutate(lugar = "Biblioteca") #columna biblioteca

bookstore_habits <- datos %>% #librería
  filter(!is.na(asistencia_nino) & !is.na(asistio_libreria_reciente)) %>%
  group_by(asistencia_nino) %>%
  summarize(
    porcentaje_asistencia = mean(asistio_libreria_reciente == "Sí") * 100
  ) %>%
  mutate(lugar = "Librería") #columna librería

summary_habits <- bind_rows(library_habits, bookstore_habits)

ggplot(summary_habits, aes(x = asistencia_nino, y = porcentaje_asistencia, fill = lugar)) +
  geom_col(position = "dodge") +
  geom_text(
    aes(label = paste0(round(porcentaje_asistencia, 1), "%")),
    position = position_dodge(width = 0.9),
    vjust = -0.5
  ) +
  labs(
    title = "Asistencia a Bibliotecas y Librerías según la Experiencia en la Niñez",
    x = "De niño, ¿lo llevaban a estos lugares?",
    y = "% que SÍ asistió recientemente",
    fill = "Lugar visitado"
  ) +
  theme_minimal()
```




```{r}
#datos <- datos %>%
  #mutate(p26 = as.numeric(na_if(p26, "b")))

#Minutos de lectura continuos según la generación
ggplot(datos, aes(x = generacion, y = p26, fill = generacion)) +
  geom_boxplot(na.rm = TRUE) +
  coord_cartesian(ylim = c(0, 180)) +
  labs(
    title = "Minutos de Lectura Continua por Generación (2019-2024)",
    x = "Generación",
    y = "Minutos Continuos de Lectura"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
#Diccionario de entidades
entidad_nombres <- data.frame(
  entidad = c("01", "02", "03", "04", "05", "06", "07", "08", "09", "10", 
              "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", 
              "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", 
              "31", "32"),
  nombre_entidad = c("Aguascalientes", "Baja California", "Baja California Sur", "Campeche", 
                     "Coahuila", "Colima", "Chihuahua", "Chiapas", "Ciudad de México", 
                     "Durango", "Guanajuato", "Guerrero", "Hidalgo", "Jalisco", 
                     "México", "Michoacán", "Morelos", "Nayarit", "Nuevo León", 
                     "Oaxaca", "Puebla", "Querétaro", "Quintana Roo", "San Luis Potosí", 
                     "Sinaloa", "Sonora", "Tabasco", "Tamaulipas", "Tlaxcala", 
                     "Veracruz", "Yucatán", "Zacatecas")
)

datos <- datos %>% mutate(entidad = formatC(entidad, width=2, flag="0"))

lectura_por_entidad <- datos %>%
  filter(!is.na(p26)) %>%
  group_by(entidad) %>%
  summarize(minutos_promedio = mean(p26, na.rm = TRUE), .groups = 'drop') %>%
  left_join(entidad_nombres, by = "entidad") %>%
  filter(!is.na(nombre_entidad))

ggplot(lectura_por_entidad, aes(x = reorder(nombre_entidad, minutos_promedio), y = minutos_promedio)) +
  geom_col(aes(fill = minutos_promedio)) +
  coord_flip() + 
  scale_fill_gradient(low = "#a8ddb5", high = "#2b8cbe") + 
  labs(
    title = "Ranking de Minutos de Lectura Continua por Estado",
    subtitle = "Promedio de todos los años (2019-2024)",
    x = "Estado",
    y = "Minutos Promedio de Lectura"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```


```{r}
entidad_nombres <- data.frame(
  entidad = c("01", "02", "03", "04", "05", "06", "07", "08", "09", "10", 
              "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", 
              "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", 
              "31", "32"),
  nombre_entidad = c("Aguascalientes", "Baja California", "Baja California Sur", "Campeche", 
                     "Coahuila", "Colima", "Chiapas", "Chihuahua", "Ciudad de México", 
                     "Durango", "Guanajuato", "Guerrero", "Hidalgo", "Jalisco", 
                     "México", "Michoacán", "Morelos", "Nayarit", "Nuevo León", 
                     "Oaxaca", "Puebla", "Querétaro", "Quintana Roo", "San Luis Potosí", 
                     "Sinaloa", "Sonora", "Tabasco", "Tamaulipas", "Tlaxcala", 
                     "Veracruz", "Yucatán", "Zacatecas")
)

datos <- datos %>% mutate(entidad = formatC(entidad, width=2, flag="0"))

libros_por_entidad <- datos %>%
  filter(!is.na(p4)) %>%
  group_by(entidad) %>%
  summarize(libros_promedio = mean(p4, na.rm = TRUE), .groups = 'drop') %>%
  left_join(entidad_nombres, by = "entidad") %>%
  filter(!is.na(nombre_entidad))

ggplot(libros_por_entidad, aes(x = reorder(nombre_entidad, libros_promedio), y = libros_promedio)) +
  geom_col(aes(fill = libros_promedio)) +
  coord_flip() +
  scale_fill_gradient(low = "#a8ddb1", high = "#2b8cbe") +
  labs(
    title = "Ranking de Libros Leídos por Estado",
    subtitle = "Promedio de todos los años (2019-2024)",
    x = "Estado",
    y = "Libros Promedio Leídos"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```



```{r}
par(mfrow = c(1, 2))

hist(
  datos$p26[datos$sexo == "Hombre"],
  main = "Hombres",
  xlab = "Minutos de Lectura",
  ylab = "Frecuencia",
  col = "skyblue3",
  breaks = 20,
  xlim = c(0, 180),
  ylim = c(0,4000)
)

hist(
  datos$p26[datos$sexo == "Mujer"],
  main = "Mujeres",
  xlab = "Minutos de Lectura",
  ylab = "Frecuencia",
  col = "salmon",
  breaks = 20,
  xlim = c(0, 180),
  ylim = c(0,4000)

)

par(mfrow = c(1, 1))
```

```{r}
# --- Histograma Facetado por Sexo y Año ---

# Nos aseguramos que las variables a usar estén limpias
datos <- datos %>%
  mutate(
    p26 = as.numeric(as.character(p26)),
    anio = as.factor(anio) # Tratar el año como categoría es mejor para facetas
  )

ggplot(datos %>% filter(!is.na(p26) & !is.na(sexo)), aes(x = p26, fill = sexo)) +
  geom_histogram(binwidth = 10, na.rm = TRUE, show.legend = FALSE) +
  scale_fill_manual(values = c("Hombre" = "skyblue3", "Mujer" = "salmon")) +
  
  # La clave: facet_grid() crea la cuadrícula. Filas por año, columnas por sexo.
  facet_grid(anio ~ sexo) +
  
  # Limitamos el eje X para una mejor comparación visual
  coord_cartesian(xlim = c(0, 180)) +
  
  labs(
    title = "Distribución de Minutos de Lectura por Sexo y Año",
    x = "Minutos Continuos de Lectura (p26)",
    y = "Frecuencia"
  ) +
  theme_minimal()
```


```{r}
datos <- datos %>%
  mutate(
    consulta_fuentes = case_when(
      p31 == "1" ~ "Sí consulta otras fuentes",
      p31 == "2" ~ "No consulta otras fuentes",
      TRUE ~ NA_character_
    )
  )

ggplot(
  datos %>% filter(!is.na(consulta_fuentes) & !is.na(generacion)),
  aes(x = generacion, fill = consulta_fuentes)
) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values = c("Sí consulta otras fuentes" = "#2c7fb8", "No consulta otras fuentes" = "cyan2")) +
  
  facet_wrap(~ anio) +
  
  labs(
    title = "Lectores que Consultan Otras Fuentes por Generación y Año",
    subtitle = "Comparación de proporciones anuales",
    x = "Generación",
    y = "Porcentaje",
    fill = "Comportamiento"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


```{r}
library(e1071)

tabla_descriptiva_edad <- datos %>%
  filter(!is.na(edad)) %>%
  group_by(anio) %>%
  summarize(
    Minimo = min(edad, na.rm = TRUE),
    Q1 = quantile(edad, 0.25, na.rm = TRUE),
    Mediana = median(edad, na.rm = TRUE),
    Media = mean(edad, na.rm = TRUE),
    Q3 = quantile(edad, 0.75, na.rm = TRUE),
    Maximo = max(edad, na.rm = TRUE),
    Desv_Est = sd(edad, na.rm = TRUE),
    Sesgo = skewness(edad, na.rm = TRUE),
    Curtosis = kurtosis(edad, na.rm = TRUE),
    .groups = 'drop'
  ) %>%

  mutate(
    Rango_Medio = (Maximo - Minimo) / 2,
    CV = (Desv_Est / Media)
  ) %>%
  select(
    anio, Minimo, Q1, Mediana, Media, Q3, Maximo, 
    Rango_Medio, Desv_Est, CV, Sesgo, Curtosis
  )

tabla_final <- t(select(tabla_descriptiva_edad, -anio))
colnames(tabla_final) <- tabla_descriptiva_edad$anio

rownames(tabla_final) <- c("Minimo", "Q1", "Mediana", "Media", "Q3", "Máximo", 
                           "Desv Est", "Sesgo", "Curtosis", "Rango Medio", "CV")

round(tabla_final, 2)
```

```{r}
library(e1071)

tabla_descriptiva_p4 <- datos %>%
  filter(!is.na(p4)) %>%
  group_by(anio) %>%
  summarize(
    Minimo = min(p4, na.rm = TRUE),
    Q1 = quantile(p4, 0.25, na.rm = TRUE),
    Mediana = median(p4, na.rm = TRUE),
    Media = mean(p4, na.rm = TRUE),
    Q3 = quantile(p4, 0.75, na.rm = TRUE),
    Maximo = max(p4, na.rm = TRUE),
    Desv_Est = sd(p4, na.rm = TRUE),
    Sesgo = skewness(p4, na.rm = TRUE),
    Curtosis = kurtosis(p4, na.rm = TRUE),
    .groups = 'drop'
  ) %>%

  mutate(
    Rango_Medio = (Maximo - Minimo) / 2,
    CV = (Desv_Est / Media)
  ) %>%
  select(
    anio, Minimo, Q1, Mediana, Media, Q3, Maximo, 
    Rango_Medio, Desv_Est, CV, Sesgo, Curtosis
  )

tabla_final <- t(select(tabla_descriptiva_p4, -anio))
colnames(tabla_final) <- tabla_descriptiva_p4$anio

rownames(tabla_final) <- c("Minimo", "Q1", "Mediana", "Media", "Q3", "Máximo", 
                           "Desv Est", "Sesgo", "Curtosis", "Rango Medio", "CV")

round(tabla_final, 2)
```


```{r}
library(e1071)

tabla_descriptiva_p26 <- datos %>%
  filter(!is.na(p26)) %>%
  group_by(anio) %>%
  summarize(
    Minimo = min(p26, na.rm = TRUE),
    Q1 = quantile(p26, 0.25, na.rm = TRUE),
    Mediana = median(p26, na.rm = TRUE),
    Media = mean(p26, na.rm = TRUE),
    Q3 = quantile(p26, 0.75, na.rm = TRUE),
    Maximo = max(p26, na.rm = TRUE),
    Desv_Est = sd(p26, na.rm = TRUE),
    Sesgo = skewness(p26, na.rm = TRUE),
    Curtosis = kurtosis(p26, na.rm = TRUE),
    .groups = 'drop'
  ) %>%

  mutate(
    Rango_Medio = (Maximo - Minimo) / 2,
    CV = (Desv_Est / Media)
  ) %>%
  select(
    anio, Minimo, Q1, Mediana, Media, Q3, Maximo, 
    Rango_Medio, Desv_Est, CV, Sesgo, Curtosis
  )

tabla_final <- t(select(tabla_descriptiva_p26, -anio))
colnames(tabla_final) <- tabla_descriptiva_p26$anio

rownames(tabla_final) <- c("Minimo", "Q1", "Mediana", "Media", "Q3", "Máximo", 
                           "Desv Est", "Sesgo", "Curtosis", "Rango Medio", "CV")

round(tabla_final, 2)
```
```{r}
entidades_unicas <- unique(datos$entidad)
promedio_educativo_entidad <- data.frame(
  entidad = character(),
  promedio_nivel = numeric()
)

for (ent in entidades_unicas) {
  
  datos_filtrados <- datos %>% filter(entidad == ent)
  promedio_actual <- mean(datos_filtrados$nivel, na.rm = TRUE)
  nueva_fila <- data.frame(entidad = ent, promedio_nivel = promedio_actual)
  promedio_educativo_entidad <- bind_rows(promedio_educativo_entidad, nueva_fila)
}

promedio_educativo_entidad <- promedio_educativo_entidad %>%
  left_join(entidad_nombres, by = "entidad") %>%
  arrange(desc(promedio_nivel)) #Ordena

print(promedio_educativo_entidad)

promedio_educativo_dplyr <- datos %>%
  filter(nivel != 99) %>% #Quitar el 99 para evitar alteración de datos
  group_by(entidad) %>% 
  summarize(
    promedio_nivel = mean(nivel, na.rm = TRUE) 
  ) %>%
  left_join(entidad_nombres, by = "entidad") %>% 
  arrange(desc(promedio_nivel))

print(promedio_educativo_dplyr)
```

```{r}
datos %>% 
  filter(nivel>"09") %>% 
  count(nivel)
```

